<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Beardify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-status-bar" content="#11151b">
  <meta name="theme-color" content="#00bbc5">
  <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:200,200i,300,300i,400,400i,700,700i" rel="stylesheet" />
  <link href="icons/styles.css" rel="stylesheet" />
  <link href="main.css" rel="stylesheet" />
  <link rel="icon" type="image/png" href="img/favicon.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/img/icon-512x512.png">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('service worker registered'))
        .catch(err => console.log('service worker not registered', err));
    }
  </script>
</head>

<body>
  <script src="app.js"></script>
  <script>
    // The localStorage key to use to store serialized session data
    const storeKey = "beardifyStore";

    const randomBytes = () => {
      const buffer = new Uint8Array(256);
      crypto.getRandomValues(buffer);
      return Array.from(buffer)
        .map(x => String.fromCharCode((x % 26) + 65))
        .join("");
    };

    const app = Elm.Main.init({
      flags: {
        clientUrl: location.origin + location.pathname,
        rawStore: localStorage[storeKey] || "",
        randomBytes: randomBytes(),
        clientId: "7122c8a266e64044b799b1c73a29115e",
        authUrl: "https://accounts.spotify.com/"
      }
    });

    app.ports.saveStore.subscribe(rawStore => {
      localStorage[storeKey] = rawStore;
    });

    // Ensure session is refreshed when it changes in another tab/window
    window.addEventListener(
      "storage",
      event => {
        if (event.storageArea === localStorage && event.key === storeKey) {
          app.ports.storeChanged.send(event.newValue);
        }
      },
      false
    );
  </script>
</body>

</html>
